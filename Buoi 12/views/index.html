<!doctype html>
<html lang="vi">

<head>

    <meta charset="utf-8">

    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Shop Demo - CRUD</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 2rem;
        }

        .thumb {
            width: 120px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="mb-4">Shop Demo — CRUD (Node.js + Sequelize + Multer)</h1>

        <div class="card mb-4">
            <div class="card-body">
                <form id="productForm" enctype="multipart/form-data">
                    <input type="hidden" id="productId" value="">
                    <div class="row g-2">
                        <div class="col-md-4">
                            <input class="form-control" id="name" placeholder="Tên sản phẩm" required>
                        </div>
                        <div class="col-md-2">
                            <input type="number" step="0.01" class="form-control" id="price" placeholder="Giá" required>
                        </div>
                        <div class="col-md-4">
                            <input class="form-control" id="description" placeholder="Mô tả">
                        </div>
                        <div class="col-md-2">
                            <input type="file" class="form-control" id="image" accept="image/*">
                        </div>
                    </div>
                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary" id="submitBtn">Thêm</button>
                        <button type="button" class="btn btn-secondary" id="resetBtn">Reset</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="productsList" class="row gy-3"></div>
    </div>

    <script>
        const apiBase = '/api/products';

        async function fetchProducts() {
            const res = await fetch(apiBase);
            const data = await res.json();
            if (!data.success) return alert('Lỗi khi tải danh sách');
            const container = document.getElementById('productsList');
            container.innerHTML = '';
            data.products.forEach(p => {
                const card = document.createElement('div');
                card.className = 'col-md-4';
                card.innerHTML = `
 <div class="card h-100">
 ${p.image ? `<img src="/uploads/${p.image}" class="card-img-top thumb" alt="${p.name}">` : ''}
 <div class="card-body">
 <h5 class="card-title">${p.name}</h5>
 <p class="card-text">${p.description || ''}</p>
 <p class="fw-bold">${p.price?.toLocaleString()} ₫</p>
 <div class="d-flex gap-2">
 <button class="btn btn-sm btn-warning" onclick="editProduct(${p.id})">Sửa</button>
 <button class="btn btn-sm btn-danger" onclick="deleteProduct(${p.id})">Xóa</button>
 </div>
 </div>
 </div>`;
                container.appendChild(card);
            });
        }

        async function deleteProduct(id) {
            if (!confirm('Xác nhận xóa?')) return;
            const res = await fetch(`${apiBase}/${id}`, { method: 'DELETE' });
            const data = await res.json();
            if (data.success) fetchProducts();
            else alert('Xóa thất bại: ' + data.message);
        }

        async function editProduct(id) {
            const res = await fetch(`${apiBase}/${id}`);
            const r = await res.json();
            if (!r.success) return alert('Không tìm thấy');
            const p = r.product;
            document.getElementById('productId').value = p.id;
            document.getElementById('name').value = p.name;
            document.getElementById('price').value = p.price;
            document.getElementById('description').value = p.description || '';
            document.getElementById('submitBtn').textContent = 'Cập nhật';
        }

        document.getElementById('resetBtn').addEventListener('click', () => {
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('submitBtn').textContent = 'Thêm';
        });

        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('productId').value;
            const form = new FormData();
            form.append('name', document.getElementById('name').value);
            form.append('price', document.getElementById('price').value);
            form.append('description', document.getElementById('description').value);
            const fileInput = document.getElementById('image');
            if (fileInput.files.length) form.append('image', fileInput.files[0]);

            const opts = {
                method: id ? 'PUT' : 'POST',
                body: form
            };
            const url = id ? `${apiBase}/${id}` : apiBase;
            const res = await fetch(url, opts);
            const data = await res.json();
            if (!data.success) return alert('Lỗi: ' + (data.message || 'unknown'));
            alert('Thành công');
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('submitBtn').textContent = 'Thêm';
            fetchProducts();
        });

        fetchProducts();
    </script>
</body>

</html>